---
description:
globs:
alwaysApply: false
---
# VRM ë·°ì–´ ë° Three.js ê°œë°œ ê·œì¹™

## ğŸ¯ **VRM ë·°ì–´ ê°œë°œ í•µì‹¬ ì›ì¹™**

### âœ… **ì˜¬ë°”ë¥¸ VRM ì²˜ë¦¬ ë°©ì‹**

#### 1. **VRM ë¡œë”© ìˆœì„œ**
```javascript
// 1. GLTFLoader ì„¤ì •
const loader = new GLTFLoader()
loader.register((parser) => new VRMLoaderPlugin(parser))

// 2. VRM ë¡œë“œ
const gltf = await loader.loadAsync(url)
const vrm = gltf.userData.vrm

// 3. ì”¬ì— ì¶”ê°€
scene.add(vrm.scene)

// 4. VRM ìµœì í™”
VRMUtils.removeUnnecessaryVertices(gltf.scene)

// 5. í¬ì¦ˆ ì¡°ì • (T-pose í•´ê²°)
adjustVRMPose(vrm)
```

#### 2. **T-pose ë¬¸ì œ í•´ê²°**
```javascript
const adjustVRMPose = (vrm) => {
  if (!vrm.humanoid) return
  
  // íŒ”ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì•„ë˜ë¡œ ë‚´ë¦¼
  const leftUpperArm = vrm.humanoid.getNormalizedBoneNode('leftUpperArm')
  const rightUpperArm = vrm.humanoid.getNormalizedBoneNode('rightUpperArm')
  
  if (leftUpperArm) leftUpperArm.rotation.z = Math.PI * 0.17   // 30ë„
  if (rightUpperArm) rightUpperArm.rotation.z = -Math.PI * 0.17 // -30ë„
}
```

### ğŸš¨ **ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ - VRM ê´€ë ¨**

#### 1. **ì˜ëª»ëœ ì• ë‹ˆë©”ì´ì…˜ ë¡œë”© ê¸ˆì§€**
```javascript
// âŒ ì˜ëª»ëœ ì˜ˆì‹œ - PropertyBinding ì—ëŸ¬ ë°œìƒ
const mixer = new THREE.AnimationMixer(vrm.scene)
const action = mixer.clipAction(gltf.animations[0])
action.play() // â†’ "No target node found" ì—ëŸ¬
```

**ì´ìœ **: VRMê³¼ ì• ë‹ˆë©”ì´ì…˜ì˜ ë³¸(bone) êµ¬ì¡°ê°€ ë§ì§€ ì•Šìœ¼ë©´ PropertyBinding ì—ëŸ¬ ë°œìƒ

#### 2. **ì„±ëŠ¥ ë¬¸ì œ ìœ ë°œ ì½”ë“œ ê¸ˆì§€**
```javascript
// âŒ ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë¬´ê±°ìš´ ì‘ì—…
function animate() {
  // ì˜ëª»ëœ ì˜ˆì‹œë“¤
  vrm.scene.traverse(() => {}) // ë§¤ í”„ë ˆì„ë§ˆë‹¤ traverse
  vrm.humanoid.getNormalizedBoneNode() // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë³¸ ê²€ìƒ‰
}
```

### ğŸ“ **Three.js ì”¬ ì„¤ì • ê·œì¹™**

#### 1. **ì¹´ë©”ë¼ ì„¤ì • (ê¸°ì¡´ í”„ë¡œì íŠ¸ ê¸°ì¤€)**
```javascript
const camera = new THREE.PerspectiveCamera(20.0, 1, 0.1, 20.0)
camera.position.set(0, 1.3, 1.5)  // ëˆˆë†’ì´ ìœ„ì¹˜

// OrbitControls ì„¤ì •
const controls = new OrbitControls(camera, renderer.domElement)
controls.target.set(0, 1.3, 0)    // ìºë¦­í„° ë¨¸ë¦¬ ë†’ì´
controls.minDistance = 0.5
controls.maxDistance = 4
```

#### 2. **ì¡°ëª… ì„¤ì • (ê¸°ì¡´ í”„ë¡œì íŠ¸ ê¸°ì¤€)**
```javascript
// ë°©í–¥ê´‘ (ì£¼ ì¡°ëª…)
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6)
directionalLight.position.set(1.0, 1.0, 1.0).normalize()

// í™˜ê²½ê´‘ (ì „ì²´ ë°ê¸°)
const ambientLight = new THREE.AmbientLight(0xffffff, 2.0)
```

#### 3. **ë°°ê²½ ì„¤ì • (ê¸°ì¡´ í”„ë¡œì íŠ¸ ê¸°ì¤€)**
```javascript
// ë Œë”ëŸ¬ ë°°ê²½ìƒ‰
renderer.setClearColor(0xf0f0f0, 1)  // ë°ì€ íšŒìƒ‰

// CSS ë°°ê²½ìƒ‰ë„ ë™ì¼í•˜ê²Œ
body { background-color: #f0f0f0; }
```

### ğŸ”§ **VRM íŒŒì¼ ê²½ë¡œ ê·œì¹™**

#### **ì •ì  ìì‚° ìœ„ì¹˜**
```
frontend/public/
â”œâ”€â”€ vrm/
â”‚   â”œâ”€â”€ AvatarSample_A.vrm
â”‚   â”œâ”€â”€ AvatarSample_B.vrm    # ê¸°ë³¸ ìºë¦­í„° (IU)
â”‚   â””â”€â”€ AvatarSample_D.vrm
â”œâ”€â”€ animations/
â”‚   â”œâ”€â”€ idle_loop.vrma        # ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜
â”‚   â”œâ”€â”€ dance.vrma
â”‚   â””â”€â”€ greeting.vrma
â””â”€â”€ favicon.ico
```

#### **URL ê²½ë¡œ (nginx ì„œë¹™)**
```javascript
// âœ… ì˜¬ë°”ë¥¸ ê²½ë¡œ
const vrmUrl = '/amica/vrm/AvatarSample_B.vrm'
const animationUrl = '/amica/animations/idle_loop.vrma'

// âŒ ì˜ëª»ëœ ê²½ë¡œ
const vrmUrl = '/vrm/AvatarSample_B.vrm'        // /amica/ ì ‘ë‘ì‚¬ ëˆ„ë½
const vrmUrl = './vrm/AvatarSample_B.vrm'       // ìƒëŒ€ê²½ë¡œ ì‚¬ìš©
```

### ğŸ“‹ **VRM ë·°ì–´ ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸**

#### VRM ë¡œë”© ì‹œ
- [ ] GLTFLoaderì— VRMLoaderPlugin ë“±ë¡í–ˆëŠ”ê°€?
- [ ] gltf.userData.vrmìœ¼ë¡œ VRM ê°ì²´ ì¶”ì¶œí–ˆëŠ”ê°€?
- [ ] VRMUtils.removeUnnecessaryVertices() ìµœì í™” ì ìš©í–ˆëŠ”ê°€?
- [ ] T-pose í•´ê²°ì„ ìœ„í•œ í¬ì¦ˆ ì¡°ì • í•¨ìˆ˜ í˜¸ì¶œí–ˆëŠ”ê°€?
- [ ] ì”¬ì— vrm.scene ì¶”ê°€í–ˆëŠ”ê°€?

#### ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬ ì‹œ
- [ ] VRMê³¼ ì• ë‹ˆë©”ì´ì…˜ì˜ ë³¸ êµ¬ì¡° í˜¸í™˜ì„± í™•ì¸í–ˆëŠ”ê°€?
- [ ] PropertyBinding ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠëŠ”ê°€?
- [ ] ì• ë‹ˆë©”ì´ì…˜ì´ ì •ë§ í•„ìš”í•œê°€? (ë‹¨ìˆœ í¬ì¦ˆ ì¡°ì •ìœ¼ë¡œ ì¶©ë¶„í•œê°€?)

#### ì„±ëŠ¥ ìµœì í™”
- [ ] frustumCulled = false ì„¤ì •í–ˆëŠ”ê°€?
- [ ] ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë¬´ê±°ìš´ ì‘ì—… í”¼í–ˆëŠ”ê°€?
- [ ] VRM ì—…ë°ì´íŠ¸ëŠ” vrm.update(deltaTime)ë§Œ í˜¸ì¶œí•˜ëŠ”ê°€?

### ğŸ¨ **UI/UX ê°€ì´ë“œë¼ì¸**

#### **ë¡œë”© ìƒíƒœ í‘œì‹œ**
```javascript
// ë¡œë”© ì§„í–‰ë¥  í‘œì‹œ
setLoadingProgress(`ë¡œë”© ì¤‘... ${percent}%`)

// ë‹¨ê³„ë³„ ìƒíƒœ í‘œì‹œ
setLoadingProgress('VRM íŒŒì¼ ë¡œë”© ì¤‘...')
setLoadingProgress('VRM ìµœì í™” ì¤‘...')
setLoadingProgress('í¬ì¦ˆ ì¡°ì • ì¤‘...')
setLoadingProgress('ë¡œë”© ì™„ë£Œ!')
```

#### **ì—ëŸ¬ ì²˜ë¦¬**
```javascript
try {
  // VRM ë¡œë”© ì½”ë“œ
} catch (err) {
  console.error('VRM ë¡œë”© ì—ëŸ¬:', err)
  setError(`VRM ë¡œë”© ì‹¤íŒ¨: ${err.message}`)
}
```

### ğŸ” **ë””ë²„ê¹… ê°€ì´ë“œ**

#### **ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë“¤**

1. **"No target node found for track" ì—ëŸ¬**
   - ì›ì¸: VRMê³¼ ì• ë‹ˆë©”ì´ì…˜ì˜ ë³¸ êµ¬ì¡° ë¶ˆì¼ì¹˜
   - í•´ê²°: ì• ë‹ˆë©”ì´ì…˜ ì œê±°í•˜ê³  í¬ì¦ˆ ì¡°ì •ìœ¼ë¡œ ëŒ€ì²´

2. **"VRM ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ì—ëŸ¬**
   - ì›ì¸: gltf.userData.vrmì´ null
   - í•´ê²°: VRMLoaderPlugin ë“±ë¡ í™•ì¸

3. **T-pose ë¬¸ì œ**
   - ì›ì¸: VRM ê¸°ë³¸ í¬ì¦ˆê°€ T-pose
   - í•´ê²°: adjustVRMPose() í•¨ìˆ˜ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ í¬ì¦ˆ ì ìš©

#### **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
```javascript
// requestAnimationFrame ì„±ëŠ¥ ì²´í¬
const startTime = performance.now()
// ë Œë”ë§ ì½”ë“œ
const endTime = performance.now()
if (endTime - startTime > 16) {
  console.warn(`í”„ë ˆì„ ì‹œê°„ ì´ˆê³¼: ${endTime - startTime}ms`)
}
```

### ğŸ“š **ì°¸ê³  ìë£Œ**

- **ê¸°ì¡´ í”„ë¡œì íŠ¸**: [backup/src/features/vrmViewer/](mdc:backup/src/features/vrmViewer/)
- **í˜„ì¬ VRM ë·°ì–´**: [frontend/src/components/VRMViewer.jsx](mdc:frontend/src/components/VRMViewer.jsx)
- **ì„¤ì • íŒŒì¼**: [backup/userdata/config.json](mdc:backup/userdata/config.json)
- **VRM íŒŒì¼ë“¤**: [frontend/public/vrm/](mdc:frontend/public/vrm/)
